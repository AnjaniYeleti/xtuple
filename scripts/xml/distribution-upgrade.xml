<package id        = "distribution-upgrade-4.11.2"
         version   = "4.11.2"
         developer = "xTuple"
         descrip   = "load PostBooks resources"
         updater   = "2.2.4" >

  <distribution-prerequisites/>
  <all-prerequisites/>

  <prerequisite type = "query"
                name = "Checking for duplicate Screens" >
    <query>SELECT NOT EXISTS(SELECT COUNT(*), uiform_name, uiform_order
                               FROM uiform
                             GROUP BY uiform_name, uiform_order
                             HAVING COUNT(*)>1);</query>
    <message>There are multiple Screens (uiform table) with the same name and grade. Please see your system administrator or contact xTuple.</message>
  </prerequisite>

  <prerequisite type = "query"
                name = "Checking for duplicate Purchase Order Types" >
    <query>
      DO $$
      BEGIN /* must nest IFs to ensure success if potype_code isn't defined */
        IF EXISTS(SELECT 1
                    FROM information_schema.columns
                    WHERE table_schema = 'public'
                      AND table_name   = 'potype'
                      AND column_name  = 'potype_code') THEN
          IF EXISTS(SELECT COUNT(*), potype_code FROM potype
                    GROUP BY potype_code HAVING COUNT(*)>1) THEN
            RAISE EXCEPTION 'There are multiple Purchase Order Types (potype table) with the same code. Please see your system administrator or contact xTuple.';
          END IF;
        END IF;
      END $$ LANGUAGE plpgsql;
      SELECT true;
    </query>
    <message>There are multiple Purchase Order Types (potype table) with the same code. Please see your system administrator or contact xTuple.</message>
  </prerequisite>

  <script file="postbooks-upgrade.sql" />
  <script file="commercialcore-upgrade.sql" />
  <script file="inventory-upgrade.sql" />
  <script file="distribution-upgrade.sql" />
  <xTuple-translations/>
  <xtcore-translations/>
  <xwd-translations/>

</package>
